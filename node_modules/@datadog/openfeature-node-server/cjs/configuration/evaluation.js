"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.evaluate = evaluate;
const server_sdk_1 = require("@openfeature/server-sdk");
const evaluateForSubject_1 = require("./evaluateForSubject");
function evaluate(config, type, flagKey, defaultValue, context, logger) {
    if (!config) {
        return {
            value: defaultValue,
            reason: 'ERROR',
            errorCode: server_sdk_1.ErrorCode.PROVIDER_NOT_READY,
        };
    }
    const { targetingKey: subjectKey, ...remainingContext } = context;
    if (!subjectKey) {
        return {
            value: defaultValue,
            reason: 'ERROR',
            errorCode: server_sdk_1.ErrorCode.TARGETING_KEY_MISSING,
        };
    }
    // Include the subjectKey as an "id" attribute for rule matching
    const subjectAttributes = {
        id: subjectKey,
        ...remainingContext,
    };
    try {
        const resultWithDetails = (0, evaluateForSubject_1.evaluateForSubject)(config.flags[flagKey], type, subjectKey, subjectAttributes, defaultValue, logger);
        return resultWithDetails;
    }
    catch (error) {
        logger.error('Error evaluating flag', { error });
        return {
            value: defaultValue,
            reason: server_sdk_1.StandardResolutionReasons.ERROR,
            errorCode: server_sdk_1.ErrorCode.GENERAL,
        };
    }
}
//# sourceMappingURL=evaluation.js.map